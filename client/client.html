<!DOCTYPE html>
<html>

<head>


</head>

<body>
    <h1>Hello world!</h1>
    <div class="token">
        <button id="btn_token_n">GET normal TOKEN</button>
        <button id="btn_token_a">GET admin TOKEN</button>
    </div>
    <div class="api">
        <button id="btn_get">GET</button>
        <button id="btn_create">CREATE</button>
        <button id="btn_update">UPDATE</button>
        <button id="btn_delete">DELETE</button>
    </div>
</body>



</html>

<script>
    let ip = '127.0.0.1'
    let btn_get = document.getElementById("btn_get")
    let btn_create = document.getElementById("btn_create")
    let btn_update = document.getElementById("btn_update")
    let btn_delete = document.getElementById("btn_delete")

    let btn_token_n = document.getElementById("btn_token_n")
    let btn_token_a = document.getElementById("btn_token_a")

    let token = null;

    btn_token_n.addEventListener("click", async () => {
        let username = "TOTO"
        let password = "PASSWORD"
        let tokenresponse = await fetch(
            "http://" + ip + ":3000/api/v1/auth",
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ username, password })
            }
        )
        let tokenA = await tokenresponse.json()
        token = tokenA
        console.log(token)
    })

    btn_token_a.addEventListener("click", async () => {
        let username = "EWEN"
        let password = "PASSWORD"
        let tokenresponse = await fetch(
            "http://" + ip + ":3000/api/v1/auth",
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ username, password })
            }
        )
        let tokenA = await tokenresponse.json()
        token = tokenA
        console.log(token)
    })

    btn_get.addEventListener("click", async () => {
        const reponse = await fetch(
            "http://localhost:3000/api/v1/workers",
            {
                headers: { Authorization: "Bearer " + token },
                method: "GET",
            }
        );
        console.log(await reponse.json())
    })

    btn_create.addEventListener("click", async () => {
        const workerName = `monWorker`;
        const oldWorkerName = 'monWorker';
        const newWorkerName = 'monWorkerNEWWW'
        const scriptName = `worker2`;
        const reponse = await fetch(
            "http://" + ip + ":3000/api/v1/workers",
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                },
                body: JSON.stringify({ workerName, scriptName })
            }
        );
        //On récupère le worker créé... ou pas!
        const port = await reponse.json();

        /* Partie consacrée à la communication avec le worker créé */
        // Créer une connexion WebSocket avec le worker
        const websocker_url = "ws://localhost:" + port;
        console.log(websocker_url)
        const socket = new WebSocket(websocker_url);
        // La connexion une fois ouverte, on salue son worker
        socket.addEventListener("open", function (event) {
            socket.send("Bonjour mon worker!");
        });
        // puis on se met à l'écoute de son worker
        socket.addEventListener("message", function (event) {
            console.log("Voici un message du worker", event.data);
        });

        socket.addEventListener("error", function (err) {
            console.error(err)
        })

    })

    btn_delete.addEventListener("click", async () => {
        const workerName = `monWorker`;
        const reponse = await fetch(
            "http://localhost:3000/api/v1/workers",
            {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                },
                body: JSON.stringify({ workerName })
            }
        );
    })

    btn_update.addEventListener("click", async () => {
        const oldWorkerName = 'monWorker';
        const newWorkerName = 'monWorkerNEWWW'
        const reponse = await fetch(
            "http://localhost:3000/api/v1/workers",
            {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                },
                body: JSON.stringify({ oldWorkerName, newWorkerName })
            }
        );
    })


</script>